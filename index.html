<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>반편성 프로그램</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Noto Sans KR', -apple-system, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }

    /* 반응형 미디어 쿼리 - 모바일 (0-768px) */
    @media (max-width: 768px) {
      .main-container {
        padding: 1rem !important;
      }
      
      .main-title {
        font-size: 1.5rem !important;
        padding: 1.5rem 1rem !important;
      }
      
      .subtitle {
        font-size: 0.75rem !important;
      }
      
      .section-card {
        padding: 1rem !important;
        margin-bottom: 1rem !important;
      }
      
      .section-title {
        font-size: 1rem !important;
      }
      
      .button-small {
        padding: 0.5rem 0.8rem !important;
        font-size: 0.8rem !important;
      }
      
      .button-medium {
        padding: 0.6rem 1rem !important;
        font-size: 0.85rem !important;
      }
      
      .button-large {
        padding: 0.8rem 1.5rem !important;
        font-size: 0.9rem !important;
      }
      
      .result-card-title {
        font-size: 1.3rem !important;
      }
      
      .result-stats {
        font-size: 0.8rem !important;
      }
      
      table {
        font-size: 0.75rem !important;
      }
      
      th {
        font-size: 0.75rem !important;
        padding: 0.5rem 0.25rem !important;
      }
      
      td {
        font-size: 0.75rem !important;
        padding: 0.4rem 0.2rem !important;
      }
      
      .score-button {
        min-width: 28px !important;
        padding: 0.3rem 0.4rem !important;
        font-size: 0.8rem !important;
      }
      
      .dropdown-score-btn {
        width: 32px !important;
        height: 32px !important;
        font-size: 0.9rem !important;
      }
      
      .special-note-btn {
        min-width: 60px !important;
        max-width: 100px !important;
        padding: 0.4rem 0.6rem !important;
        font-size: 0.75rem !important;
      }
      
      /* 모바일에서 양식 다운로드 버튼 표시/숨김 */
      .mobile-template-btn {
        display: flex !important;
      }
      
      .desktop-template-btn {
        display: none !important;
      }
    }

    /* 반응형 미디어 쿼리 - 태블릿 (769px-1024px) */
    @media (min-width: 769px) and (max-width: 1024px) {
      .main-container {
        padding: 1.5rem !important;
      }
      
      .main-title {
        font-size: 2rem !important;
      }
      
      table {
        font-size: 0.85rem !important;
      }
      
      th, td {
        font-size: 0.85rem !important;
      }
    }

    /* 반응형 그리드 */
    @media (max-width: 640px) {
      .result-grid {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
      }
      
      .button-flex {
        flex-direction: column !important;
        gap: 0.75rem !important;
      }
      
      .button-flex button {
        width: 100% !important;
      }
    }

    @media (min-width: 641px) and (max-width: 1024px) {
      .result-grid {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }

    /* 모달 반응형 */
    @media (max-width: 768px) {
      .modal-content {
        width: 90% !important;
        max-width: 90% !important;
        padding: 1.25rem !important;
        max-height: 85vh !important;
        overflow-y: auto !important;
      }
      
      .modal-title {
        font-size: 1.2rem !important;
      }
      
      .modal-button-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.5rem !important;
      }
    }

    /* 텍스트 줄바꿈 방지 및 말줄임 */
    .text-nowrap {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* 터치 디바이스 최적화 */
    @media (hover: none) and (pointer: coarse) {
      button, .clickable {
        min-height: 44px;
        min-width: 44px;
      }
    }

    /* 스크롤바 스타일 (모바일 최적화) */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* 모바일에서 테이블 최적화 */
    @media (max-width: 768px) {
      table {
        min-width: 100%;
      }
      
      ::-webkit-scrollbar {
        width: 4px;
        height: 4px;
      }

      .privacy-banner {
        flex-direction: column !important;
        text-align: center !important;
      }

      .privacy-banner-icon {
        margin: 0 auto !important;
      }

      .privacy-footer {
        padding: 1rem !important;
        font-size: 0.8rem !important;
      }

      .privacy-footer br {
        display: none;
      }
    }

    #root {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    // Lucide Icons as SVG components
    const Upload = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="17 8 12 3 7 8" />
        <line x1="12" y1="3" x2="12" y2="15" />
      </svg>
    );

    const Settings = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="3" />
        <path d="M12 1v6m0 6v6m-9-9h6m6 0h6" />
      </svg>
    );

    const Plus = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="5" x2="12" y2="19" />
        <line x1="5" y1="12" x2="19" y2="12" />
      </svg>
    );

    const X = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="18" y1="6" x2="6" y2="18" />
        <line x1="6" y1="6" x2="18" y2="18" />
      </svg>
    );

    const Trash2 = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="3 6 5 6 21 6" />
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
        <line x1="10" y1="11" x2="10" y2="17" />
        <line x1="14" y1="11" x2="14" y2="17" />
      </svg>
    );

    const Users = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
        <circle cx="9" cy="7" r="4" />
        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
      </svg>
    );

    const Play = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polygon points="5 3 19 12 5 21 5 3" />
      </svg>
    );

    const Download = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="7 10 12 15 17 10" />
        <line x1="12" y1="15" x2="12" y2="3" />
      </svg>
    );

    const Check = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="20 6 9 17 4 12" />
      </svg>
    );

    const Save = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
        <polyline points="17 21 17 13 7 13 7 21" />
        <polyline points="7 3 7 8 15 8" />
      </svg>
    );

    const Edit = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
      </svg>
    );

    function ClassAssignment() {
      // localStorage에서 데이터 로드
      React.useEffect(() => {
        try {
          const savedStudents = localStorage.getItem('class_assignment_students');
          const savedCategories = localStorage.getItem('class_assignment_categories');
          const savedScores = localStorage.getItem('class_assignment_scores');
          const savedNotes = localStorage.getItem('class_assignment_notes');
          const savedNumClasses = localStorage.getItem('class_assignment_numClasses');
          
          if (savedStudents) setStudents(JSON.parse(savedStudents));
          if (savedCategories) setCategories(JSON.parse(savedCategories));
          if (savedScores) setStudentScores(JSON.parse(savedScores));
          if (savedNotes) setStudentSpecialNotes(JSON.parse(savedNotes));
          if (savedNumClasses) setNumClasses(parseInt(savedNumClasses));
        } catch (error) {
          console.error('데이터 로드 오류:', error);
        }
      }, []);

      // 데이터 변경 시 localStorage에 자동 저장
      React.useEffect(() => {
        if (students.length > 0) {
          localStorage.setItem('class_assignment_students', JSON.stringify(students));
        }
      }, [students]);

      React.useEffect(() => {
        if (categories.length > 0) {
          localStorage.setItem('class_assignment_categories', JSON.stringify(categories));
        }
      }, [categories]);

      React.useEffect(() => {
        if (Object.keys(studentScores).length > 0) {
          localStorage.setItem('class_assignment_scores', JSON.stringify(studentScores));
        }
      }, [studentScores]);

      React.useEffect(() => {
        if (Object.keys(studentSpecialNotes).length > 0) {
          localStorage.setItem('class_assignment_notes', JSON.stringify(studentSpecialNotes));
        }
      }, [studentSpecialNotes]);

      React.useEffect(() => {
        localStorage.setItem('class_assignment_numClasses', numClasses.toString());
      }, [numClasses]);

      // 모든 데이터 초기화 함수
      const clearAllData = () => {
        if (confirm('모든 데이터를 초기화하시겠습니까?\n(이 작업은 되돌릴 수 없습니다)')) {
          localStorage.clear();
          setStudents([]);
          setCategories([]);
          setStudentScores({});
          setStudentSpecialNotes({});
          setSeparatePairs([]);
          setResults(null);
          setNumClasses(3);
          setIsInputComplete(false);
          setIsEditMode(true);
          setIsResultSaved(false);
          setIsResultEditMode(false);
          setSelectedStudentsForSwap([]);
          alert('모든 데이터가 초기화되었습니다.');
        }
      };

      const [students, setStudents] = useState([]);
      const [numClasses, setNumClasses] = useState(3);
      const [categories, setCategories] = useState([]);
      const [newCategoryName, setNewCategoryName] = useState('');
      const [studentScores, setStudentScores] = useState({});
      const [studentSpecialNotes, setStudentSpecialNotes] = useState({});
      const [separatePairs, setSeparatePairs] = useState([]);
      const [newPair, setNewPair] = useState({ student1: '', student2: '' });
      const [results, setResults] = useState(null);
      const [showClassModal, setShowClassModal] = useState(false);
      const [showCategoryModal, setShowCategoryModal] = useState(false);
      const [activeScoreDropdown, setActiveScoreDropdown] = useState(null);
      const [activeSpecialNoteDropdown, setActiveSpecialNoteDropdown] = useState(null);
      const [isInputComplete, setIsInputComplete] = useState(false);
      const [isEditMode, setIsEditMode] = useState(true);
      const [selectedStudentsForSwap, setSelectedStudentsForSwap] = useState([]);
      const [isResultSaved, setIsResultSaved] = useState(false);
      const [isResultEditMode, setIsResultEditMode] = useState(false);
      const [nameSortOrder, setNameSortOrder] = useState(null); // null, 'asc', 'desc'
      const [genderSortOrder, setGenderSortOrder] = useState(null); // null, 'male-first', 'female-first'

      const specialNoteOptions = ['운동부', '도움반', '쌍생아', '다문화'];

      // 페이지 새로고침/종료 시 경고
      React.useEffect(() => {
        const handleBeforeUnload = (e) => {
          if (students.length > 0) {
            const message = '⚠️ 페이지를 새로고침하면 모든 데이터가 삭제됩니다. 계속하시겠습니까?';
            e.preventDefault();
            e.returnValue = message;
            return message;
          }
        };

        window.addEventListener('beforeunload', handleBeforeUnload);

        return () => {
          window.removeEventListener('beforeunload', handleBeforeUnload);
        };
      }, [students]);

      const categoryExamples = [
        '성적', '학습태도', '교우관계', '리더십', 
        '협동성', '주의집중력', '책임감', '사회성'
      ];

      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          const workbook = XLSX.read(event.target.result, { type: 'binary' });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const data = XLSX.utils.sheet_to_json(sheet);

          const formattedStudents = data.map((row, index) => ({
            id: index,
            studentId: row['학생개인번호'] || '',
            name: row['이름'] || row['name'] || '',
            gender: row['성별'] || row['gender'] || '',
            grade: row['학년'] || row['grade'] || '',
            originalClass: row['반'] || row['원래반'] || row['class'] || '',
            number: row['번호'] || row['number'] || '',
            birthDate: row['생년월일'] || '',
            specialNote: row['특이사항'] || ''
          }));

          setStudents(formattedStudents);
          setStudentScores({});
          setResults(null);
        };
        reader.readAsBinaryString(file);
      };

      const downloadTemplate = () => {
        // 양식 데이터 생성
        const templateData = [
          { '학생개인번호': '2024001', '학년': '3', '반': '1', '번호': '1', '이름': '홍길동', '성별': '남', '생년월일': '2017-03-15', '특이사항': '', '원래반': '1', '배정반': '' },
          { '학생개인번호': '2024002', '학년': '3', '반': '1', '번호': '2', '이름': '김영희', '성별': '여', '생년월일': '2017-05-20', '특이사항': '', '원래반': '1', '배정반': '' },
          { '학생개인번호': '2024003', '학년': '3', '반': '1', '번호': '3', '이름': '이철수', '성별': '남', '생년월일': '2017-08-10', '특이사항': '', '원래반': '1', '배정반': '' },
        ];

        // 워크시트 생성
        const worksheet = XLSX.utils.json_to_sheet(templateData);
        
        // 워크북 생성
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, '학생명렬표');

        // 파일 다운로드
        XLSX.writeFile(workbook, '학생명렬표_양식.xlsx');
      };

      const handleComplete = () => {
        if (students.length === 0) {
          alert('학생 명렬표를 먼저 업로드해주세요.');
          return;
        }
        if (categories.length === 0) {
          alert('최소 1개 이상의 특성 카테고리를 추가해주세요.');
          return;
        }
        alert('입력이 완료되었습니다! 반편성 실행 버튼을 눌러주세요.');
      };

      const addCategory = () => {
        if (newCategoryName.trim()) {
          setCategories([...categories, { id: Date.now(), name: newCategoryName }]);
          setNewCategoryName('');
        }
      };

      const toggleCategoryFromModal = (categoryName) => {
        const existingCategory = categories.find(cat => cat.name === categoryName);
        if (existingCategory) {
          // 이미 추가된 카테고리면 삭제
          removeCategory(existingCategory.id);
        } else {
          // 없으면 추가
          setCategories([...categories, { id: Date.now(), name: categoryName }]);
        }
      };

      const selectNumClasses = (num) => {
        setNumClasses(num);
        setShowClassModal(false);
      };

      const toggleScoreDropdown = (studentId, categoryId) => {
        if (!isEditMode) {
          alert('입력 수정 버튼을 클릭하여 수정 모드로 전환해주세요.');
          return;
        }
        const key = `${studentId}-${categoryId}`;
        if (activeScoreDropdown === key) {
          setActiveScoreDropdown(null);
        } else {
          setActiveScoreDropdown(key);
        }
      };

      const toggleSpecialNoteDropdown = (studentId) => {
        if (!isEditMode) {
          alert('입력 수정 버튼을 클릭하여 수정 모드로 전환해주세요.');
          return;
        }
        if (activeSpecialNoteDropdown === studentId) {
          setActiveSpecialNoteDropdown(null);
        } else {
          setActiveSpecialNoteDropdown(studentId);
        }
      };

      const selectScore = (studentId, categoryId, score) => {
        const newScores = { ...studentScores };
        if (!newScores[studentId]) {
          newScores[studentId] = {};
        }
        newScores[studentId][categoryId] = score;
        setStudentScores(newScores);
        setActiveScoreDropdown(null);
      };

      const toggleSpecialNote = (studentId, note) => {
        const newNotes = { ...studentSpecialNotes };
        if (!newNotes[studentId]) {
          newNotes[studentId] = [];
        }
        
        const currentNotes = [...newNotes[studentId]];
        const index = currentNotes.indexOf(note);
        
        if (index > -1) {
          // 이미 선택되어 있으면 제거
          newNotes[studentId] = currentNotes.filter((_, i) => i !== index);
        } else {
          // 선택되어 있지 않으면 추가
          newNotes[studentId] = [...currentNotes, note];
        }
        
        setStudentSpecialNotes(newNotes);
      };

      const toggleInputComplete = () => {
        if (isEditMode) {
          // 입력 완료
          if (students.length === 0) {
            alert('학생 명렬표를 먼저 업로드해주세요.');
            return;
          }
          if (categories.length === 0) {
            alert('최소 1개 이상의 특성 카테고리를 추가해주세요.');
            return;
          }
          setIsInputComplete(true);
          setIsEditMode(false);
          alert('입력이 완료되었습니다!');
        } else {
          // 입력 수정
          setIsEditMode(true);
        }
      };

      const handleStudentClickForSwap = (student, className) => {
        if (!isResultEditMode) {
          return;
        }

        const studentWithClass = { ...student, className };
        const existingIndex = selectedStudentsForSwap.findIndex(
          s => s.id === student.id && s.className === className
        );

        if (existingIndex > -1) {
          // 이미 선택된 학생이면 선택 해제
          setSelectedStudentsForSwap(selectedStudentsForSwap.filter((_, i) => i !== existingIndex));
        } else if (selectedStudentsForSwap.length < 2) {
          // 2명 미만이면 추가
          setSelectedStudentsForSwap([...selectedStudentsForSwap, studentWithClass]);
        } else {
          // 2명 선택된 상태에서 새로운 학생 선택 시 첫 번째 학생 교체
          setSelectedStudentsForSwap([selectedStudentsForSwap[1], studentWithClass]);
        }

        // 2명 선택되면 자동으로 교체
        if (selectedStudentsForSwap.length === 1) {
          const newSelected = [...selectedStudentsForSwap, studentWithClass];
          if (newSelected.length === 2) {
            swapStudents(newSelected[0], newSelected[1]);
          }
        }
      };

      const swapStudents = (student1, student2) => {
        if (student1.className === student2.className) {
          alert('같은 반의 학생은 교체할 수 없습니다.');
          setSelectedStudentsForSwap([]);
          return;
        }

        const newResults = results.map(cls => {
          if (cls.name === student1.className) {
            // student1을 student2로 교체
            return {
              ...cls,
              students: cls.students.map(s => s.id === student1.id ? student2 : s),
              maleCount: cls.students.filter(s => {
                if (s.id === student1.id) return student2.gender === '남' || student2.gender === 'M';
                return s.gender === '남' || s.gender === 'M';
              }).length,
              femaleCount: cls.students.filter(s => {
                if (s.id === student1.id) return student2.gender === '여' || student2.gender === 'F';
                return s.gender === '여' || s.gender === 'F';
              }).length
            };
          } else if (cls.name === student2.className) {
            // student2를 student1로 교체
            return {
              ...cls,
              students: cls.students.map(s => s.id === student2.id ? student1 : s),
              maleCount: cls.students.filter(s => {
                if (s.id === student2.id) return student1.gender === '남' || student1.gender === 'M';
                return s.gender === '남' || s.gender === 'M';
              }).length,
              femaleCount: cls.students.filter(s => {
                if (s.id === student2.id) return student1.gender === '여' || student1.gender === 'F';
                return s.gender === '여' || s.gender === 'F';
              }).length
            };
          }
          return cls;
        });

        setResults(newResults);
        setSelectedStudentsForSwap([]);
        alert(`${student1.name}과(와) ${student2.name}의 반이 교체되었습니다.`);
      };

      const toggleResultSave = () => {
        if (!isResultSaved) {
          // 결과 저장
          setIsResultSaved(true);
          setIsResultEditMode(false);
          setSelectedStudentsForSwap([]);
          alert('반편성 결과가 저장되었습니다!');
        }
      };

      const toggleResultEdit = () => {
        if (isResultSaved) {
          // 결과 수정 모드 시작
          setIsResultEditMode(true);
          setIsResultSaved(false);
          setSelectedStudentsForSwap([]);
        }
      };

      const removeCategory = (categoryId) => {
        setCategories(categories.filter(cat => cat.id !== categoryId));
        const newScores = { ...studentScores };
        Object.keys(newScores).forEach(studentId => {
          if (newScores[studentId]) {
            delete newScores[studentId][categoryId];
          }
        });
        setStudentScores(newScores);
      };

      const addSeparatePair = () => {
        if (newPair.student1 && newPair.student2 && newPair.student1 !== newPair.student2) {
          setSeparatePairs([...separatePairs, { ...newPair, id: Date.now() }]);
          setNewPair({ student1: '', student2: '' });
        }
      };

      const removePair = (pairId) => {
        setSeparatePairs(separatePairs.filter(pair => pair.id !== pairId));
      };

      const assignClasses = () => {
        if (students.length === 0) {
          alert('먼저 학생 명렬표를 업로드해주세요.');
          return;
        }

        // 점수 계산 함수
        const calculateCategoryScore = (studentId) => {
          if (!studentScores[studentId]) return 0;
          return Object.values(studentScores[studentId]).reduce((sum, score) => sum + score, 0);
        };

        // 반 초기화
        const classes = Array.from({ length: numClasses }, (_, i) => ({
          name: String.fromCharCode(65 + i), // A, B, C...
          students: [],
          totalScore: 0,
          maleCount: 0,
          femaleCount: 0
        }));

        // 남녀 학생 분리 및 점수 순 정렬 (높은 점수 -> 낮은 점수)
        const maleStudents = students
          .filter(s => s.gender === '남' || s.gender === 'M')
          .map(s => ({ ...s, score: calculateCategoryScore(s.id) }))
          .sort((a, b) => b.score - a.score);

        const femaleStudents = students
          .filter(s => s.gender === '여' || s.gender === 'F')
          .map(s => ({ ...s, score: calculateCategoryScore(s.id) }))
          .sort((a, b) => b.score - a.score);

        // 운동부 학생 분산 배치 함수 (라운드 로빈 방식)
        const distributeAthletes = (studentList, isMale) => {
          // 운동부 학생과 일반 학생 분리
          const athletes = studentList.filter(s => 
            studentSpecialNotes[s.id]?.includes('운동부')
          );
          const nonAthletes = studentList.filter(s => 
            !studentSpecialNotes[s.id]?.includes('운동부')
          );

          // 운동부 학생을 각 반에 순환 배치
          let classIndex = 0;
          for (let i = 0; i < athletes.length; i++) {
            const student = athletes[i];
            let assigned = false;
            let attempts = 0;

            // 같은 반 금지 학생 목록
            const separateStudentIds = separatePairs
              .filter(pair => pair.student1 === student.name || pair.student2 === student.name)
              .map(pair => pair.student1 === student.name ? pair.student2 : pair.student1);

            // 현재 반부터 시작해서 가능한 반 찾기
            while (!assigned && attempts < numClasses) {
              const cls = classes[classIndex];

              // 같은 반 금지 확인
              const hasSeparateStudent = cls.students.some(s => 
                separateStudentIds.includes(s.name)
              );

              if (!hasSeparateStudent) {
                cls.students.push(student);
                cls.totalScore += student.score;
                if (isMale) {
                  cls.maleCount++;
                } else {
                  cls.femaleCount++;
                }
                assigned = true;
              } else {
                // 다음 반으로
                classIndex = (classIndex + 1) % numClasses;
                attempts++;
              }
            }

            // 금지 조건 때문에 배정 못한 경우
            if (!assigned) {
              const sortedByCount = [...classes].sort((a, b) => a.students.length - b.students.length);
              const lowestClass = sortedByCount[0];
              lowestClass.students.push(student);
              lowestClass.totalScore += student.score;
              if (isMale) {
                lowestClass.maleCount++;
              } else {
                lowestClass.femaleCount++;
              }
              assigned = true;
            }

            if (assigned) {
              // 다음 반으로 이동 (라운드 로빈)
              classIndex = (classIndex + 1) % numClasses;
            }
          }

          return nonAthletes;
        };

        // 스네이크 드래프트 방식 배정 함수
        const snakeDraftAssign = (studentList, isMale) => {
          let classIndex = 0;
          let direction = 1; // 1: 정방향, -1: 역방향

          for (let i = 0; i < studentList.length; i++) {
            const student = studentList[i];
            let assigned = false;
            let attempts = 0;

            // 같은 반 금지 학생 목록
            const separateStudentIds = separatePairs
              .filter(pair => pair.student1 === student.name || pair.student2 === student.name)
              .map(pair => pair.student1 === student.name ? pair.student2 : pair.student1);

            // 현재 인덱스부터 시작해서 가능한 반 찾기
            while (!assigned && attempts < numClasses) {
              const cls = classes[classIndex];

              // 같은 반 금지 확인
              const hasSeparateStudent = cls.students.some(s => 
                separateStudentIds.includes(s.name)
              );

              if (!hasSeparateStudent) {
                cls.students.push(student);
                cls.totalScore += student.score;
                if (isMale) {
                  cls.maleCount++;
                } else {
                  cls.femaleCount++;
                }
                assigned = true;
              } else {
                // 금지 학생이 있으면 다음 반으로
                classIndex += direction;
                if (classIndex >= numClasses) {
                  classIndex = numClasses - 1;
                  direction = -1;
                } else if (classIndex < 0) {
                  classIndex = 0;
                  direction = 1;
                }
                attempts++;
              }
            }

            // 금지 조건 때문에 배정 못한 경우 학생 수가 가장 적은 반에 배정
            if (!assigned) {
              const sortedByCount = [...classes].sort((a, b) => a.students.length - b.students.length);
              const lowestClass = sortedByCount[0];
              lowestClass.students.push(student);
              lowestClass.totalScore += student.score;
              if (isMale) {
                lowestClass.maleCount++;
              } else {
                lowestClass.femaleCount++;
              }
              assigned = true;
            }

            if (assigned) {
              // 다음 반으로 이동 (스네이크 패턴)
              classIndex += direction;
              
              // 끝에 도달하면 방향 전환
              if (classIndex >= numClasses) {
                classIndex = numClasses - 1;
                direction = -1;
              } else if (classIndex < 0) {
                classIndex = 0;
                direction = 1;
              }
            }
          }
        };

        // 1단계: 운동부 남학생 분산 배치 후 일반 남학생 반환
        const nonAthleteMales = distributeAthletes(maleStudents, true);
        
        // 2단계: 운동부 여학생 분산 배치 후 일반 여학생 반환
        const nonAthleteFemales = distributeAthletes(femaleStudents, false);

        // 3단계: 일반 남학생 스네이크 드래프트 배정
        snakeDraftAssign(nonAthleteMales, true);
        
        // 4단계: 일반 여학생 스네이크 드래프트 배정
        snakeDraftAssign(nonAthleteFemales, false);

        // 각 반의 학생 수가 균등한지 확인 및 재조정
        const avgStudentsPerClass = students.length / numClasses;
        const maxDifference = 2; // 최대 학생 수 차이

        // 학생 수 균등화 (필요시)
        let needsBalancing = true;
        let balanceAttempts = 0;
        const maxBalanceAttempts = 10;

        while (needsBalancing && balanceAttempts < maxBalanceAttempts) {
          needsBalancing = false;
          balanceAttempts++;

          const sortedBySize = [...classes].sort((a, b) => b.students.length - a.students.length);
          const largest = sortedBySize[0];
          const smallest = sortedBySize[sortedBySize.length - 1];

          if (largest.students.length - smallest.students.length > maxDifference) {
            // 가장 큰 반에서 가장 작은 반으로 학생 이동
            for (let i = largest.students.length - 1; i >= 0; i--) {
              const student = largest.students[i];
              
              // 같은 반 금지 확인
              const separateStudentIds = separatePairs
                .filter(pair => pair.student1 === student.name || pair.student2 === student.name)
                .map(pair => pair.student1 === student.name ? pair.student2 : pair.student1);
              
              const hasSeparateStudent = smallest.students.some(s => 
                separateStudentIds.includes(s.name)
              );

              if (!hasSeparateStudent) {
                // 학생 이동
                largest.students.splice(i, 1);
                smallest.students.push(student);
                
                // 카운트 업데이트
                if (student.gender === '남' || student.gender === 'M') {
                  largest.maleCount--;
                  smallest.maleCount++;
                } else {
                  largest.femaleCount--;
                  smallest.femaleCount++;
                }
                
                largest.totalScore -= student.score;
                smallest.totalScore += student.score;
                
                needsBalancing = true;
                break;
              }
            }
          }
        }

        setResults(classes);
        setIsResultSaved(false);
        setIsResultEditMode(true);
        setSelectedStudentsForSwap([]);
        setNameSortOrder(null); // 정렬 상태 초기화
        setGenderSortOrder(null); // 정렬 상태 초기화
      };

      // 이름순 정렬 함수
      const toggleNameSort = () => {
        if (!results) return;

        const newSortOrder = nameSortOrder === 'asc' ? 'desc' : 'asc';
        setNameSortOrder(newSortOrder);
        setGenderSortOrder(null); // 다른 정렬 초기화

        const sortedResults = results.map(cls => ({
          ...cls,
          students: [...cls.students].sort((a, b) => {
            if (newSortOrder === 'asc') {
              return a.name.localeCompare(b.name, 'ko');
            } else {
              return b.name.localeCompare(a.name, 'ko');
            }
          })
        }));

        setResults(sortedResults);
      };

      // 성별순 정렬 함수
      const toggleGenderSort = () => {
        if (!results) return;

        const newSortOrder = genderSortOrder === 'male-first' ? 'female-first' : 'male-first';
        setGenderSortOrder(newSortOrder);
        setNameSortOrder(null); // 다른 정렬 초기화

        const sortedResults = results.map(cls => ({
          ...cls,
          students: [...cls.students].sort((a, b) => {
            const aIsMale = a.gender === '남' || a.gender === 'M';
            const bIsMale = b.gender === '남' || b.gender === 'M';

            if (newSortOrder === 'male-first') {
              if (aIsMale && !bIsMale) return -1;
              if (!aIsMale && bIsMale) return 1;
              return a.name.localeCompare(b.name, 'ko'); // 같은 성별 내에서는 이름순
            } else {
              if (!aIsMale && bIsMale) return -1;
              if (aIsMale && !bIsMale) return 1;
              return a.name.localeCompare(b.name, 'ko'); // 같은 성별 내에서는 이름순
            }
          })
        }));

        setResults(sortedResults);
      };

      const downloadExcel = () => {
        if (!results) {
          alert('먼저 반편성을 실행해주세요.');
          return;
        }

        // 원본 시트 데이터 생성
        const originalData = [];
        results.forEach(cls => {
          cls.students.forEach(student => {
            originalData.push({
              '학생개인번호': student.studentId || '',
              '학년': student.grade || '',
              '반': student.originalClass || '',
              '번호': student.number || '',
              '이름': student.name,
              '성별': student.gender,
              '생년월일': student.birthDate || '',
              '특이사항': studentSpecialNotes[student.id]?.join(', ') || student.specialNote || '',
              '원래반': student.originalClass || '',
              '배정반': cls.name + '반'
            });
          });
        });

        // 원본 시트 생성
        const originalSheet = XLSX.utils.json_to_sheet(originalData);

        // 워크북 생성
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, originalSheet, '원본');

        // 각 반별 시트 생성
        results.forEach(cls => {
          const classData = cls.students.map(student => ({
            '학생개인번호': student.studentId || '',
            '학년': student.grade || '',
            '반': student.originalClass || '',
            '번호': student.number || '',
            '이름': student.name,
            '성별': student.gender,
            '생년월일': student.birthDate || '',
            '특이사항': studentSpecialNotes[student.id]?.join(', ') || student.specialNote || '',
            '원래반': student.originalClass || ''
          }));
          
          const classSheet = XLSX.utils.json_to_sheet(classData);
          XLSX.utils.book_append_sheet(workbook, classSheet, cls.name + '반');
        });

        // 파일 다운로드
        const fileName = `반편성_결과_${new Date().getFullYear()}${String(new Date().getMonth() + 1).padStart(2, '0')}${String(new Date().getDate()).padStart(2, '0')}.xlsx`;
        XLSX.writeFile(workbook, fileName);
      };

      return (
        <div 
          className="main-container"
          style={{
            minHeight: '100vh',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            padding: '2rem',
            fontFamily: "'Noto Sans KR', -apple-system, sans-serif"
          }}
          onClick={() => {
            setActiveScoreDropdown(null);
            setActiveSpecialNoteDropdown(null);
          }}
        >
          <div 
            style={{
              maxWidth: '1400px',
              margin: '0 auto',
              background: 'rgba(255, 255, 255, 0.98)',
              borderRadius: '24px',
              boxShadow: '0 25px 50px rgba(0, 0, 0, 0.25)',
              overflow: 'hidden'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* 헤더 */}
            <div style={{
              background: 'linear-gradient(135deg, #5f72e4 0%, #6d5ca6 100%)',
              padding: '3rem 2rem',
              position: 'relative',
              overflow: 'hidden',
              textAlign: 'center'
            }}>
              <div style={{
                position: 'absolute',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'radial-gradient(circle at 30% 50%, rgba(255,255,255,0.1) 0%, transparent 50%)',
                pointerEvents: 'none'
              }}></div>
              
              <h1 style={{
                fontSize: '2.5rem',
                fontWeight: '800',
                color: 'white',
                margin: 0,
                letterSpacing: '-0.5px',
                position: 'relative'
              }}>반편성 프로그램 (학급용)</h1>
              <p style={{
                color: 'rgba(255, 255, 255, 0.9)',
                fontSize: '1rem',
                marginTop: '0.5rem',
                position: 'relative'
              }}>학생 특성을 고려한 균형잡힌 반편성</p>
            </div>

            <div style={{ padding: '2rem' }}>
              {/* 설정 섹션 */}
              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',
                gap: '1.5rem',
                marginBottom: '2rem'
              }}>
                {/* 파일 업로드 카드 */}
                <div style={{
                  background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                  borderRadius: '16px',
                  padding: '2rem',
                  color: 'white',
                  boxShadow: '0 10px 30px rgba(240, 147, 251, 0.3)'
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem' }}>
                    <Upload />
                    <h3 style={{ margin: '0 0 0 0.5rem', fontSize: '1.2rem', fontWeight: '700' }}>
                      학생 명렬표 업로드
                    </h3>
                  </div>
                  <div style={{ display: 'flex', gap: '0.75rem', marginBottom: '1rem' }}>
                    <input
                      type="file"
                      accept=".xlsx,.xls"
                      onChange={handleFileUpload}
                      style={{
                        flex: 1,
                        padding: '0.75rem',
                        background: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        color: '#333',
                        fontWeight: '500'
                      }}
                    />
                    <button
                      onClick={downloadTemplate}
                      className="desktop-template-btn"
                      style={{
                        padding: '0.75rem 1.25rem',
                        background: 'white',
                        color: '#f5576c',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontWeight: '600',
                        fontSize: '0.9rem',
                        whiteSpace: 'nowrap',
                        boxShadow: '0 2px 8px rgba(0, 0, 0, 0.1)',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.5rem'
                      }}
                    >
                      <Download />
                      양식 다운로드
                    </button>
                  </div>
                  {students.length > 0 && (
                    <div style={{ 
                      marginTop: '1rem', 
                      display: 'flex', 
                      justifyContent: 'space-between',
                      alignItems: 'center',
                      gap: '0.75rem'
                    }}>
                      <p style={{ 
                        fontSize: '0.9rem', 
                        opacity: 0.95,
                        margin: 0,
                        flex: 1,
                        minWidth: 0
                      }}>
                        ✓ {students.length}명의 학생 로드됨
                      </p>
                      <button
                        onClick={downloadTemplate}
                        className="mobile-template-btn"
                        style={{
                          padding: '0.5rem 0.75rem',
                          background: 'rgba(255, 255, 255, 0.3)',
                          color: 'white',
                          border: '1px solid rgba(255, 255, 255, 0.5)',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontWeight: '600',
                          fontSize: '0.75rem',
                          whiteSpace: 'nowrap',
                          display: 'none',
                          alignItems: 'center',
                          gap: '0.3rem',
                          transition: 'all 0.2s',
                          flexShrink: 0
                        }}
                        onMouseEnter={(e) => {
                          e.target.style.background = 'rgba(255, 255, 255, 0.4)';
                        }}
                        onMouseLeave={(e) => {
                          e.target.style.background = 'rgba(255, 255, 255, 0.3)';
                        }}
                      >
                        <Download style={{ width: '14px', height: '14px' }} />
                        양식
                      </button>
                    </div>
                  )}
                </div>

                {/* 학급 수 설정 카드 */}
                <div style={{
                  background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                  borderRadius: '16px',
                  padding: '2rem',
                  color: 'white',
                  boxShadow: '0 10px 30px rgba(79, 172, 254, 0.3)'
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem' }}>
                    <Settings />
                    <h3 style={{ margin: '0 0 0 0.5rem', fontSize: '1.2rem', fontWeight: '700' }}>
                      학급 수 설정
                    </h3>
                  </div>
                  <button
                    onClick={() => setShowClassModal(true)}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      background: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontSize: '1rem',
                      fontWeight: '600',
                      color: '#333',
                      cursor: 'pointer',
                      textAlign: 'left',
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center'
                    }}
                  >
                    <span>{numClasses}개 학급</span>
                    <span style={{ fontSize: '1.2rem' }}>▼</span>
                  </button>
                  <p style={{ marginTop: '1rem', fontSize: '0.9rem', opacity: 0.95 }}>
                    학급당 약 {students.length > 0 ? Math.ceil(students.length / numClasses) : 0}명
                  </p>
                </div>
              </div>

              {/* 카테고리 관리 */}
              <div style={{
                background: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                borderRadius: '16px',
                padding: '2rem',
                marginBottom: '2rem',
                boxShadow: '0 10px 30px rgba(252, 182, 159, 0.3)'
              }}>
                <h3 style={{
                  fontSize: '1.3rem',
                  fontWeight: '700',
                  marginBottom: '1.5rem',
                  color: '#8b4513',
                  display: 'flex',
                  alignItems: 'center'
                }}>
                  <Plus />
                  <span style={{ marginLeft: '0.5rem' }}>학생 특성 카테고리 관리</span>
                </h3>
                
                <div style={{ marginBottom: '1.5rem' }}>
                  <button
                    onClick={() => setShowCategoryModal(true)}
                    style={{
                      width: '100%',
                      padding: '1rem 1.5rem',
                      background: '#8b4513',
                      color: 'white',
                      border: 'none',
                      borderRadius: '12px',
                      fontWeight: '600',
                      cursor: 'pointer',
                      fontSize: '1rem',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '0.5rem'
                    }}
                  >
                    <Plus />
                    <span>특성 카테고리 추가하기</span>
                  </button>
                </div>

                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.75rem' }}>
                  {categories.map(cat => (
                    <div
                      key={cat.id}
                      style={{
                        background: 'white',
                        padding: '0.5rem 1rem',
                        borderRadius: '20px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.5rem',
                        boxShadow: '0 2px 8px rgba(0, 0, 0, 0.1)',
                        fontWeight: '500',
                        color: '#8b4513'
                      }}
                    >
                      {cat.name}
                      <button
                        onClick={() => removeCategory(cat.id)}
                        style={{
                          background: 'none',
                          border: 'none',
                          color: '#f5576c',
                          cursor: 'pointer',
                          padding: '0',
                          display: 'flex',
                          alignItems: 'center'
                        }}
                      >
                        <X />
                      </button>
                    </div>
                  ))}
                </div>
                {categories.length === 0 && (
                  <p style={{ 
                    textAlign: 'center', 
                    color: '#8b4513', 
                    marginTop: '1rem',
                    opacity: 0.8
                  }}>
                    추가된 카테고리가 없습니다. 위 버튼을 눌러 카테고리를 추가하세요.
                  </p>
                )}
              </div>

              {/* 학생 목록 */}
              {students.length > 0 && (
                <div style={{
                  background: 'white',
                  borderRadius: '16px',
                  padding: '2rem',
                  marginBottom: '2rem',
                  border: '2px solid #e0e0e0'
                }}>
                  <h3 style={{
                    fontSize: '1.3rem',
                    fontWeight: '700',
                    marginBottom: '1.5rem',
                    color: '#333',
                    display: 'flex',
                    alignItems: 'center'
                  }}>
                    <Users />
                    <span style={{ marginLeft: '0.5rem' }}>학생 목록 및 특성 점수</span>
                  </h3>

                  <div style={{ 
                    overflowX: 'auto',
                    maxHeight: '600px',
                    overflowY: 'auto',
                    border: '1px solid #e0e0e0',
                    borderRadius: '8px',
                    position: 'relative',
                    WebkitOverflowScrolling: 'touch'
                  }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                      <thead>
                        <tr style={{ background: '#f5f5f5' }}>
                          <th style={{ 
                            padding: '0.75rem 0.5rem', 
                            textAlign: 'left', 
                            fontWeight: '600',
                            fontSize: '0.9rem',
                            position: 'sticky',
                            top: 0,
                            background: '#f5f5f5',
                            zIndex: 10
                          }}>이름</th>
                          <th style={{ 
                            padding: '0.75rem 0.5rem', 
                            textAlign: 'center', 
                            fontWeight: '600',
                            fontSize: '0.9rem',
                            position: 'sticky',
                            top: 0,
                            background: '#f5f5f5',
                            zIndex: 10
                          }}>성별</th>
                          {categories.map(cat => (
                            <th key={cat.id} style={{ 
                              padding: '0.75rem 0.5rem', 
                              textAlign: 'center', 
                              fontWeight: '600',
                              fontSize: '0.9rem',
                              position: 'sticky',
                              top: 0,
                              background: '#f5f5f5',
                              zIndex: 10,
                              whiteSpace: 'nowrap'
                            }}>
                              {cat.name}
                            </th>
                          ))}
                          <th style={{ 
                            padding: '0.75rem 0.5rem', 
                            textAlign: 'center', 
                            fontWeight: '600',
                            fontSize: '0.9rem',
                            position: 'sticky',
                            top: 0,
                            background: '#f5f5f5',
                            zIndex: 10,
                            whiteSpace: 'nowrap'
                          }}>특이사항</th>
                        </tr>
                      </thead>
                      <tbody>
                        {students.map((student, idx) => (
                          <tr
                            key={student.id}
                            style={{
                              borderBottom: '1px solid #e0e0e0',
                              background: idx % 2 === 0 ? 'white' : '#fafafa'
                            }}
                          >
                            <td style={{ padding: '0.75rem 0.5rem', fontWeight: '500', fontSize: '0.9rem' }}>{student.name}</td>
                            <td style={{ padding: '0.75rem 0.5rem', textAlign: 'center' }}>
                              <span style={{
                                padding: '0.2rem 0.5rem',
                                borderRadius: '8px',
                                background: student.gender === '남' || student.gender === 'M' ? '#e3f2fd' : '#fce4ec',
                                color: student.gender === '남' || student.gender === 'M' ? '#1976d2' : '#c2185b',
                                fontWeight: '600',
                                fontSize: '0.8rem'
                              }}>
                                {student.gender}
                              </span>
                            </td>
                            {categories.map(cat => {
                              const dropdownKey = `${student.id}-${cat.id}`;
                              const isDropdownActive = activeScoreDropdown === dropdownKey;
                              const currentScore = studentScores[student.id]?.[cat.id];
                              
                              return (
                                <td 
                                  key={cat.id} 
                                  style={{ 
                                    padding: '0.5rem 0.25rem', 
                                    textAlign: 'center',
                                    position: 'relative'
                                  }}
                                >
                                  <div
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      toggleScoreDropdown(student.id, cat.id);
                                    }}
                                    style={{
                                      display: 'inline-block',
                                      minWidth: '35px',
                                      padding: '0.4rem 0.6rem',
                                      fontSize: '0.95rem',
                                      fontWeight: '600',
                                      color: currentScore ? '#667eea' : '#ccc',
                                      border: currentScore ? '2px solid #667eea' : '2px solid #e0e0e0',
                                      borderRadius: '6px',
                                      background: 'white',
                                      cursor: isEditMode ? 'pointer' : 'default',
                                      transition: 'all 0.2s',
                                      position: 'relative',
                                      zIndex: isDropdownActive ? 200 : 1
                                    }}
                                  >
                                    {currentScore || '-'}
                                    
                                    {isDropdownActive && (
                                      <div
                                        style={{
                                          position: 'absolute',
                                          top: 'calc(100% + 0.5rem)',
                                          left: '50%',
                                          transform: 'translateX(-50%)',
                                          background: 'white',
                                          borderRadius: '10px',
                                          boxShadow: '0 10px 30px rgba(0, 0, 0, 0.3)',
                                          padding: '0.4rem',
                                          zIndex: 1000,
                                          display: 'flex',
                                          gap: '0.4rem',
                                          whiteSpace: 'nowrap'
                                        }}
                                        onClick={(e) => e.stopPropagation()}
                                      >
                                        {[5, 4, 3, 2, 1].map(score => (
                                          <button
                                            key={score}
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              selectScore(student.id, cat.id, score);
                                            }}
                                            style={{
                                              width: '40px',
                                              height: '40px',
                                              background: currentScore === score
                                                ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                                                : '#f5f5f5',
                                              color: currentScore === score ? 'white' : '#333',
                                              border: 'none',
                                              borderRadius: '8px',
                                              cursor: 'pointer',
                                              fontWeight: '700',
                                              fontSize: '1.1rem',
                                              transition: 'all 0.2s'
                                            }}
                                            onMouseEnter={(e) => {
                                              if (currentScore !== score) {
                                                e.target.style.background = '#e0e0e0';
                                              }
                                            }}
                                            onMouseLeave={(e) => {
                                              if (currentScore !== score) {
                                                e.target.style.background = '#f5f5f5';
                                              }
                                            }}
                                          >
                                            {score}
                                          </button>
                                        ))}
                                      </div>
                                    )}
                                  </div>
                                </td>
                              );
                            })}
                            
                            {/* 특이사항 셀 */}
                            <td 
                              style={{ 
                                padding: '0.5rem 0.25rem', 
                                textAlign: 'center',
                                position: 'relative'
                              }}
                            >
                              <div
                                onClick={(e) => {
                                  e.stopPropagation();
                                  if (isEditMode) {
                                    toggleSpecialNoteDropdown(student.id);
                                  } else {
                                    alert('입력 수정 버튼을 클릭하여 수정 모드로 전환해주세요.');
                                  }
                                }}
                                id={`special-note-btn-${student.id}`}
                                style={{
                                  display: 'inline-block',
                                  minWidth: '80px',
                                  maxWidth: '140px',
                                  padding: '0.6rem 0.9rem',
                                  fontSize: '0.9rem',
                                  fontWeight: '600',
                                  color: studentSpecialNotes[student.id]?.length > 0 ? 'white' : '#666',
                                  border: '2px solid #e67e22',
                                  borderRadius: '8px',
                                  background: studentSpecialNotes[student.id]?.length > 0 
                                    ? 'linear-gradient(135deg, #e67e22 0%, #d35400 100%)'
                                    : 'white',
                                  cursor: isEditMode ? 'pointer' : 'not-allowed',
                                  transition: 'all 0.2s',
                                  whiteSpace: 'nowrap',
                                  overflow: 'hidden',
                                  textOverflow: 'ellipsis',
                                  position: 'relative',
                                  boxShadow: isEditMode ? '0 2px 4px rgba(0, 0, 0, 0.1)' : 'none'
                                }}
                                onMouseEnter={(e) => {
                                  if (isEditMode) {
                                    e.currentTarget.style.transform = 'scale(1.05)';
                                    e.currentTarget.style.boxShadow = '0 4px 8px rgba(230, 126, 34, 0.3)';
                                  }
                                }}
                                onMouseLeave={(e) => {
                                  if (isEditMode) {
                                    e.currentTarget.style.transform = 'scale(1)';
                                    e.currentTarget.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                                  }
                                }}
                              >
                                {studentSpecialNotes[student.id]?.length > 0 
                                  ? studentSpecialNotes[student.id].join(', ') 
                                  : '선택'}
                              </div>
                              
                              {activeSpecialNoteDropdown === student.id && (
                                <div
                                  style={{
                                    position: 'fixed',
                                    top: (() => {
                                      const btn = document.getElementById(`special-note-btn-${student.id}`);
                                      if (btn) {
                                        const rect = btn.getBoundingClientRect();
                                        return `${rect.bottom + 8}px`;
                                      }
                                      return '50%';
                                    })(),
                                    left: (() => {
                                      const btn = document.getElementById(`special-note-btn-${student.id}`);
                                      if (btn) {
                                        const rect = btn.getBoundingClientRect();
                                        return `${rect.left + rect.width / 2}px`;
                                      }
                                      return '50%';
                                    })(),
                                    transform: 'translateX(-50%)',
                                    background: 'white',
                                    borderRadius: '12px',
                                    boxShadow: '0 15px 40px rgba(0, 0, 0, 0.35)',
                                    padding: '0.75rem',
                                    zIndex: 3000,
                                    minWidth: '160px',
                                    border: '3px solid #e67e22'
                                  }}
                                  onClick={(e) => e.stopPropagation()}
                                >
                                  <div style={{
                                    fontSize: '0.85rem',
                                    fontWeight: '700',
                                    color: '#e67e22',
                                    marginBottom: '0.6rem',
                                    textAlign: 'center',
                                    borderBottom: '2px solid #e67e22',
                                    paddingBottom: '0.5rem'
                                  }}>
                                    📋 특이사항 선택
                                  </div>
                                  {specialNoteOptions.map((note, noteIdx) => {
                                    const isSelected = studentSpecialNotes[student.id]?.includes(note);
                                    return (
                                      <div
                                        key={note}
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          toggleSpecialNote(student.id, note);
                                        }}
                                        style={{
                                          padding: '0.8rem 1rem',
                                          background: isSelected ? '#e67e22' : '#f8f8f8',
                                          color: isSelected ? 'white' : '#333',
                                          borderRadius: '8px',
                                          cursor: 'pointer',
                                          marginBottom: noteIdx < specialNoteOptions.length - 1 ? '0.5rem' : '0',
                                          fontWeight: isSelected ? '700' : '600',
                                          fontSize: '1rem',
                                          transition: 'all 0.2s',
                                          display: 'flex',
                                          alignItems: 'center',
                                          gap: '0.7rem',
                                          userSelect: 'none',
                                          border: isSelected ? '2px solid #d35400' : '2px solid transparent'
                                        }}
                                        onMouseEnter={(e) => {
                                          if (!isSelected) {
                                            e.currentTarget.style.background = '#e0e0e0';
                                            e.currentTarget.style.transform = 'scale(1.03)';
                                          }
                                        }}
                                        onMouseLeave={(e) => {
                                          if (!isSelected) {
                                            e.currentTarget.style.background = '#f8f8f8';
                                            e.currentTarget.style.transform = 'scale(1)';
                                          }
                                        }}
                                      >
                                        <span style={{ 
                                          width: '24px',
                                          height: '24px',
                                          display: 'flex',
                                          alignItems: 'center',
                                          justifyContent: 'center',
                                          fontWeight: '900',
                                          fontSize: '1.3rem',
                                          background: isSelected ? 'rgba(255, 255, 255, 0.3)' : '#ddd',
                                          borderRadius: '6px'
                                        }}>
                                          {isSelected ? '✓' : ''}
                                        </span>
                                        <span style={{ flex: 1 }}>{note}</span>
                                      </div>
                                    );
                                  })}
                                </div>
                              )}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {/* 같은 반 금지 학생 */}
              {students.length > 0 && (
                <div style={{
                  background: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                  borderRadius: '16px',
                  padding: '2rem',
                  marginBottom: '2rem',
                  boxShadow: '0 10px 30px rgba(255, 154, 158, 0.3)'
                }}>
                  <h3 style={{
                    fontSize: '1.3rem',
                    fontWeight: '700',
                    marginBottom: '1.5rem',
                    color: '#c2185b'
                  }}>
                    같은 반 금지 학생 설정
                  </h3>

                  <div style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                    <select
                      value={newPair.student1}
                      onChange={(e) => setNewPair({ ...newPair, student1: e.target.value })}
                      style={{
                        flex: 1,
                        minWidth: '200px',
                        padding: '0.75rem',
                        border: '2px solid rgba(194, 24, 91, 0.2)',
                        borderRadius: '12px',
                        fontSize: '1rem',
                        background: 'white'
                      }}
                    >
                      <option value="">학생 선택</option>
                      {students.map(s => (
                        <option key={s.id} value={s.name}>{s.name}</option>
                      ))}
                    </select>

                    <select
                      value={newPair.student2}
                      onChange={(e) => setNewPair({ ...newPair, student2: e.target.value })}
                      style={{
                        flex: 1,
                        minWidth: '200px',
                        padding: '0.75rem',
                        border: '2px solid rgba(194, 24, 91, 0.2)',
                        borderRadius: '12px',
                        fontSize: '1rem',
                        background: 'white'
                      }}
                    >
                      <option value="">학생 선택</option>
                      {students.map(s => (
                        <option key={s.id} value={s.name}>{s.name}</option>
                      ))}
                    </select>

                    <button
                      onClick={addSeparatePair}
                      style={{
                        padding: '0.75rem 2rem',
                        background: '#c2185b',
                        color: 'white',
                        border: 'none',
                        borderRadius: '12px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        whiteSpace: 'nowrap'
                      }}
                    >
                      추가
                    </button>
                  </div>

                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.75rem' }}>
                    {separatePairs.map(pair => (
                      <div
                        key={pair.id}
                        style={{
                          background: 'white',
                          padding: '0.5rem 1rem',
                          borderRadius: '20px',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.5rem',
                          boxShadow: '0 2px 8px rgba(0, 0, 0, 0.1)',
                          fontWeight: '500',
                          color: '#c2185b'
                        }}
                      >
                        {pair.student1} ↔ {pair.student2}
                        <button
                          onClick={() => removePair(pair.id)}
                          style={{
                            background: 'none',
                            border: 'none',
                            color: '#f5576c',
                            cursor: 'pointer',
                            padding: '0',
                            display: 'flex',
                            alignItems: 'center'
                          }}
                        >
                          <Trash2 />
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* 입력완료 & 반편성 실행 버튼 */}
              {students.length > 0 && (
                <div style={{ 
                  display: 'flex', 
                  gap: '1.5rem', 
                  justifyContent: 'center',
                  marginBottom: '2rem',
                  flexWrap: 'wrap'
                }}>
                  <button
                    onClick={toggleInputComplete}
                    style={{
                      padding: '1.25rem 3rem',
                      background: isEditMode 
                        ? 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)'
                        : 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                      color: 'white',
                      border: 'none',
                      borderRadius: '16px',
                      fontSize: '1.2rem',
                      fontWeight: '700',
                      cursor: 'pointer',
                      boxShadow: isEditMode
                        ? '0 10px 30px rgba(17, 153, 142, 0.4)'
                        : '0 10px 30px rgba(240, 147, 251, 0.4)',
                      transition: 'transform 0.2s',
                      display: 'inline-flex',
                      alignItems: 'center',
                      gap: '0.5rem',
                      minWidth: '200px',
                      justifyContent: 'center'
                    }}
                    onMouseEnter={(e) => e.target.style.transform = 'scale(1.05)'}
                    onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                  >
                    <Check />
                    {isEditMode ? '입력 완료' : '입력 수정'}
                  </button>

                  <button
                    onClick={assignClasses}
                    disabled={!isInputComplete}
                    style={{
                      padding: '1.25rem 3rem',
                      background: isInputComplete
                        ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                        : '#ccc',
                      color: 'white',
                      border: 'none',
                      borderRadius: '16px',
                      fontSize: '1.2rem',
                      fontWeight: '700',
                      cursor: isInputComplete ? 'pointer' : 'not-allowed',
                      boxShadow: isInputComplete
                        ? '0 10px 30px rgba(102, 126, 234, 0.4)'
                        : 'none',
                      transition: 'transform 0.2s',
                      display: 'inline-flex',
                      alignItems: 'center',
                      gap: '0.5rem',
                      minWidth: '200px',
                      justifyContent: 'center',
                      opacity: isInputComplete ? 1 : 0.6
                    }}
                    onMouseEnter={(e) => {
                      if (isInputComplete) {
                        e.target.style.transform = 'scale(1.05)';
                      }
                    }}
                    onMouseLeave={(e) => {
                      e.target.style.transform = 'scale(1)';
                    }}
                  >
                    <Play />
                    반편성 실행하기
                  </button>
                </div>
              )}

              {/* 결과 표시 */}
              {results && (
                <div>
                  <div style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '1.5rem',
                    flexWrap: 'wrap',
                    gap: '1rem'
                  }}>
                    <h3 style={{
                      fontSize: '1.5rem',
                      fontWeight: '700',
                      color: '#333',
                      margin: 0
                    }}>
                      반편성 결과
                    </h3>
                    
                    <div style={{ 
                      display: 'flex', 
                      gap: '0.75rem',
                      flexWrap: 'wrap',
                      alignItems: 'center'
                    }}>
                      {/* 가나다순 정렬 버튼 */}
                      <button
                        onClick={toggleNameSort}
                        style={{
                          padding: '0.75rem 1.25rem',
                          background: nameSortOrder ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'white',
                          color: nameSortOrder ? 'white' : '#667eea',
                          border: nameSortOrder ? 'none' : '2px solid #667eea',
                          borderRadius: '12px',
                          fontWeight: '600',
                          cursor: 'pointer',
                          fontSize: '0.9rem',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.5rem',
                          boxShadow: nameSortOrder ? '0 4px 12px rgba(102, 126, 234, 0.3)' : 'none',
                          transition: 'all 0.2s'
                        }}
                        onMouseEnter={(e) => {
                          e.target.style.transform = 'scale(1.05)';
                        }}
                        onMouseLeave={(e) => {
                          e.target.style.transform = 'scale(1)';
                        }}
                      >
                        {nameSortOrder === 'asc' ? '🔼' : nameSortOrder === 'desc' ? '🔽' : '🔤'}
                        가나다분류
                      </button>

                      {/* 성별순 정렬 버튼 */}
                      <button
                        onClick={toggleGenderSort}
                        style={{
                          padding: '0.75rem 1.25rem',
                          background: genderSortOrder ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' : 'white',
                          color: genderSortOrder ? 'white' : '#f5576c',
                          border: genderSortOrder ? 'none' : '2px solid #f5576c',
                          borderRadius: '12px',
                          fontWeight: '600',
                          cursor: 'pointer',
                          fontSize: '0.9rem',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.5rem',
                          boxShadow: genderSortOrder ? '0 4px 12px rgba(245, 87, 108, 0.3)' : 'none',
                          transition: 'all 0.2s'
                        }}
                        onMouseEnter={(e) => {
                          e.target.style.transform = 'scale(1.05)';
                        }}
                        onMouseLeave={(e) => {
                          e.target.style.transform = 'scale(1)';
                        }}
                      >
                        {genderSortOrder === 'male-first' ? '👦👧' : genderSortOrder === 'female-first' ? '👧👦' : '⚥'}
                        성별분류
                      </button>

                      {/* 엑셀 다운로드 버튼 */}
                      <button
                        onClick={downloadExcel}
                        title="엑셀 파일은 귀하의 기기에만 저장됩니다"
                        style={{
                          padding: '0.75rem 1.5rem',
                          background: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
                          color: 'white',
                          border: 'none',
                          borderRadius: '12px',
                          fontWeight: '600',
                          cursor: 'pointer',
                          fontSize: '0.95rem',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.5rem',
                          boxShadow: '0 4px 12px rgba(17, 153, 142, 0.3)',
                          transition: 'transform 0.2s'
                        }}
                        onMouseEnter={(e) => e.target.style.transform = 'scale(1.05)'}
                        onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                      >
                        <Download />
                        엑셀 다운로드
                      </button>
                    </div>
                  </div>

                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',
                    gap: '1.5rem'
                  }}>
                    {results.map((cls, idx) => (
                      <div
                        key={cls.name}
                        style={{
                          background: `linear-gradient(135deg, ${
                            ['#a8edea', '#fbc2eb', '#fed6e3', '#a6c1ee', '#ffecd2'][idx % 5]
                          } 0%, ${
                            ['#fed6e3', '#a6c1ee', '#ffecd2', '#a8edea', '#fbc2eb'][idx % 5]
                          } 100%)`,
                          borderRadius: '16px',
                          padding: '1.5rem',
                          boxShadow: '0 10px 30px rgba(0, 0, 0, 0.15)'
                        }}
                      >
                        <h4 style={{
                          fontSize: '1.5rem',
                          fontWeight: '700',
                          marginBottom: '1rem',
                          color: '#333'
                        }}>
                          {cls.name}반
                        </h4>

                        <div style={{
                          background: 'rgba(255, 255, 255, 0.7)',
                          padding: '0.75rem',
                          borderRadius: '12px',
                          marginBottom: '1rem',
                          fontSize: '0.9rem',
                          fontWeight: '600'
                        }}>
                          <div>총 {cls.students.length}명</div>
                          <div>남 {cls.maleCount}명 / 여 {cls.femaleCount}명</div>
                        </div>

                        <div style={{
                          background: 'white',
                          borderRadius: '12px',
                          padding: '1rem',
                          maxHeight: '300px',
                          overflowY: 'auto'
                        }}>
                          {cls.students.map((student, sIdx) => {
                            const isSelected = selectedStudentsForSwap.some(
                              s => s.id === student.id && s.className === cls.name
                            );
                            
                            return (
                              <div
                                key={student.id}
                                onClick={() => handleStudentClickForSwap(student, cls.name)}
                                style={{
                                  padding: '0.75rem',
                                  borderBottom: sIdx < cls.students.length - 1 ? '1px solid #e0e0e0' : 'none',
                                  display: 'flex',
                                  justifyContent: 'space-between',
                                  alignItems: 'center',
                                  cursor: isResultEditMode ? 'pointer' : 'default',
                                  background: isSelected ? '#fff3cd' : 'transparent',
                                  borderRadius: '8px',
                                  transition: 'all 0.2s',
                                  border: '2px solid transparent'
                                }}
                                onMouseEnter={(e) => {
                                  if (isResultEditMode) {
                                    e.currentTarget.style.background = isSelected ? '#fff3cd' : '#f0f7ff';
                                    e.currentTarget.style.border = '2px solid #667eea';
                                    e.currentTarget.style.transform = 'translateX(4px)';
                                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.2)';
                                    const hint = e.currentTarget.querySelector('.click-hint');
                                    if (hint) hint.style.display = 'inline-block';
                                  }
                                }}
                                onMouseLeave={(e) => {
                                  if (isResultEditMode) {
                                    e.currentTarget.style.background = isSelected ? '#fff3cd' : 'transparent';
                                    e.currentTarget.style.border = '2px solid transparent';
                                    e.currentTarget.style.transform = 'translateX(0)';
                                    e.currentTarget.style.boxShadow = 'none';
                                    const hint = e.currentTarget.querySelector('.click-hint');
                                    if (hint) hint.style.display = 'none';
                                  }
                                }}
                              >
                                <span style={{ 
                                  fontWeight: isSelected ? '700' : '500',
                                  color: '#333',
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '0.5rem',
                                  flex: 1
                                }}>
                                  {isSelected && (
                                    <span style={{
                                      display: 'inline-flex',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                      width: '20px',
                                      height: '20px',
                                      background: '#ffc107',
                                      borderRadius: '50%',
                                      fontSize: '0.75rem',
                                      fontWeight: '700',
                                      color: '#fff'
                                    }}>
                                      ✓
                                    </span>
                                  )}
                                  {student.name}
                                  {studentSpecialNotes[student.id]?.length > 0 && (
                                    <span style={{
                                      fontSize: '0.7rem',
                                      padding: '0.15rem 0.4rem',
                                      background: '#e67e22',
                                      color: 'white',
                                      borderRadius: '4px',
                                      fontWeight: '600'
                                    }}>
                                      {studentSpecialNotes[student.id].join(', ')}
                                    </span>
                                  )}
                                  {isResultEditMode && (
                                    <span 
                                      className="click-hint"
                                      style={{
                                        fontSize: '0.7rem',
                                        padding: '0.2rem 0.5rem',
                                        background: '#667eea',
                                        color: 'white',
                                        borderRadius: '4px',
                                        fontWeight: '600',
                                        marginLeft: 'auto',
                                        display: 'none'
                                      }}
                                    >
                                      👆 클릭하여 교체
                                    </span>
                                  )}
                                </span>
                                <span style={{
                                  padding: '0.25rem 0.5rem',
                                  borderRadius: '8px',
                                  background: student.gender === '남' || student.gender === 'M' ? '#e3f2fd' : '#fce4ec',
                                  color: student.gender === '남' || student.gender === 'M' ? '#1976d2' : '#c2185b',
                                  fontSize: '0.85rem',
                                  fontWeight: '600'
                                }}>
                                  {student.gender}
                                </span>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    ))}
                  </div>

                  {/* 결과 저장/수정 버튼 */}
                  <div style={{ textAlign: 'center', marginTop: '2rem' }}>
                    {isResultEditMode && (
                      <div style={{
                        marginBottom: '1rem',
                        padding: '1rem',
                        background: 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)',
                        borderRadius: '12px',
                        fontSize: '0.95rem',
                        color: '#1565c0',
                        fontWeight: '600',
                        display: 'inline-block'
                      }}>
                        💡 학생 이름을 클릭하여 반을 교체할 수 있습니다
                      </div>
                    )}
                    
                    <div style={{ 
                      display: 'flex', 
                      gap: '1rem', 
                      justifyContent: 'center',
                      flexWrap: 'wrap'
                    }}>
                      {/* 결과 수정하기 버튼 */}
                      {isResultSaved && (
                        <button
                          onClick={toggleResultEdit}
                          style={{
                            padding: '1rem 2.5rem',
                            background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '12px',
                            fontSize: '1.1rem',
                            fontWeight: '700',
                            cursor: 'pointer',
                            boxShadow: '0 8px 20px rgba(240, 147, 251, 0.4)',
                            transition: 'transform 0.2s'
                          }}
                          onMouseEnter={(e) => e.target.style.transform = 'scale(1.05)'}
                          onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                        >
                          결과 수정하기
                        </button>
                      )}
                      
                      {/* 반편성 결과 저장하기 버튼 */}
                      {!isResultSaved && (
                        <button
                          onClick={toggleResultSave}
                          style={{
                            padding: '1rem 2.5rem',
                            background: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '12px',
                            fontSize: '1.1rem',
                            fontWeight: '700',
                            cursor: 'pointer',
                            boxShadow: '0 8px 20px rgba(17, 153, 142, 0.4)',
                            transition: 'transform 0.2s'
                          }}
                          onMouseEnter={(e) => e.target.style.transform = 'scale(1.05)'}
                          onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                        >
                          반편성 결과 저장하기
                        </button>
                      )}
                    </div>
                    
                    {isResultEditMode && selectedStudentsForSwap.length > 0 && (
                      <div style={{
                        marginTop: '1rem',
                        padding: '0.75rem',
                        background: '#fff3cd',
                        borderRadius: '8px',
                        fontSize: '0.95rem',
                        color: '#856404',
                        display: 'inline-block'
                      }}>
                        ✓ {selectedStudentsForSwap.length}명 선택됨 - {2 - selectedStudentsForSwap.length}명 더 선택하여 반 교체
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* 학급 수 선택 모달 */}
          {showClassModal && (
            <div
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0, 0, 0, 0.6)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 1000,
                padding: '1rem'
              }}
              onClick={() => setShowClassModal(false)}
            >
              <div
                onClick={(e) => e.stopPropagation()}
                style={{
                  background: 'white',
                  borderRadius: '20px',
                  padding: '2rem',
                  maxWidth: '500px',
                  width: '100%',
                  boxShadow: '0 25px 50px rgba(0, 0, 0, 0.3)'
                }}
              >
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  marginBottom: '1.5rem',
                  paddingBottom: '1rem',
                  borderBottom: '2px solid #e0e0e0'
                }}>
                  <h3 style={{ fontSize: '1.5rem', fontWeight: '700', color: '#333', margin: 0 }}>
                    학급 수 선택
                  </h3>
                  <button
                    onClick={() => setShowClassModal(false)}
                    style={{
                      background: 'none',
                      border: 'none',
                      cursor: 'pointer',
                      padding: '0.5rem',
                      color: '#999'
                    }}
                  >
                    <X />
                  </button>
                </div>

                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(5, 1fr)',
                  gap: '1rem',
                  marginBottom: '1rem'
                }}>
                  {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => (
                    <button
                      key={num}
                      onClick={() => selectNumClasses(num)}
                      style={{
                        padding: '1.5rem 1rem',
                        background: numClasses === num
                          ? 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
                          : '#f5f5f5',
                        color: numClasses === num ? 'white' : '#333',
                        border: 'none',
                        borderRadius: '12px',
                        cursor: 'pointer',
                        fontWeight: '700',
                        fontSize: '1.5rem',
                        transition: 'all 0.2s',
                        boxShadow: numClasses === num
                          ? '0 4px 12px rgba(79, 172, 254, 0.4)'
                          : 'none'
                      }}
                    >
                      {num}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* 카테고리 선택 모달 */}
          {showCategoryModal && (
            <div
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0, 0, 0, 0.6)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 1000,
                padding: '1rem'
              }}
              onClick={() => setShowCategoryModal(false)}
            >
              <div
                onClick={(e) => e.stopPropagation()}
                style={{
                  background: 'white',
                  borderRadius: '20px',
                  padding: '2rem',
                  maxWidth: '600px',
                  width: '100%',
                  boxShadow: '0 25px 50px rgba(0, 0, 0, 0.3)'
                }}
              >
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  marginBottom: '1.5rem',
                  paddingBottom: '1rem',
                  borderBottom: '2px solid #e0e0e0'
                }}>
                  <h3 style={{ fontSize: '1.5rem', fontWeight: '700', color: '#333', margin: 0 }}>
                    학생 특성 카테고리 선택
                  </h3>
                  <button
                    onClick={() => setShowCategoryModal(false)}
                    style={{
                      background: 'none',
                      border: 'none',
                      cursor: 'pointer',
                      padding: '0.5rem',
                      color: '#999'
                    }}
                  >
                    <X />
                  </button>
                </div>

                <p style={{ 
                  color: '#666', 
                  marginBottom: '1.5rem',
                  fontSize: '0.95rem'
                }}>
                  추가할 특성을 선택하세요. 다시 클릭하면 선택이 취소됩니다.
                </p>

                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(2, 1fr)',
                  gap: '1rem',
                  marginBottom: '1.5rem'
                }}>
                  {categoryExamples.map(catName => {
                    const isAdded = categories.some(cat => cat.name === catName);
                    return (
                      <button
                        key={catName}
                        onClick={() => toggleCategoryFromModal(catName)}
                        style={{
                          padding: '1.25rem',
                          background: isAdded
                            ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                            : 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                          color: isAdded ? 'white' : '#8b4513',
                          border: 'none',
                          borderRadius: '12px',
                          cursor: 'pointer',
                          fontWeight: '600',
                          fontSize: '1.1rem',
                          transition: 'all 0.2s',
                          boxShadow: isAdded 
                            ? '0 4px 12px rgba(102, 126, 234, 0.4)' 
                            : '0 4px 12px rgba(252, 182, 159, 0.3)',
                          position: 'relative',
                          transform: 'scale(1)'
                        }}
                        onMouseEnter={(e) => {
                          if (!isAdded) {
                            e.target.style.transform = 'scale(1.05)';
                          }
                        }}
                        onMouseLeave={(e) => {
                          e.target.style.transform = 'scale(1)';
                        }}
                      >
                        {catName}
                        {isAdded && (
                          <span style={{
                            position: 'absolute',
                            top: '0.5rem',
                            right: '0.5rem',
                            fontSize: '1rem',
                            color: 'white'
                          }}>✓</span>
                        )}
                      </button>
                    );
                  })}
                </div>

                <div style={{ 
                  padding: '1rem',
                  background: '#f5f5f5',
                  borderRadius: '12px',
                  marginTop: '1rem'
                }}>
                  <p style={{ 
                    fontSize: '0.9rem', 
                    color: '#666',
                    margin: 0,
                    textAlign: 'center'
                  }}>
                    <strong>현재 {categories.length}개</strong>의 카테고리가 추가되어 있습니다.
                  </p>
                </div>

                <button
                  onClick={() => setShowCategoryModal(false)}
                  style={{
                    width: '100%',
                    marginTop: '1.5rem',
                    padding: '1rem',
                    background: 'linear-gradient(135deg, #8b4513 0%, #a0522d 100%)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '12px',
                    fontWeight: '600',
                    cursor: 'pointer',
                    fontSize: '1rem',
                    boxShadow: '0 4px 12px rgba(139, 69, 19, 0.3)'
                  }}
                >
                  완료
                </button>
              </div>
            </div>
          )}

          {/* 개인정보 보호 푸터 */}
          <div className="privacy-footer" style={{
            marginTop: '3rem',
            padding: '1.5rem',
            background: 'rgba(255, 255, 255, 0.1)',
            borderRadius: '12px',
            textAlign: 'center',
            border: '1px solid rgba(255, 255, 255, 0.2)'
          }}>
            <div style={{
              fontSize: '1.5rem',
              marginBottom: '0.5rem'
            }}>🔐</div>
            <div style={{
              color: 'white',
              fontSize: '0.9rem',
              lineHeight: '1.6',
              maxWidth: '800px',
              margin: '0 auto'
            }}>
              <strong>개인정보 보호 안내</strong><br/>
              이 프로그램은 100% 로컬 전용입니다. 모든 데이터는 귀하의 브라우저 메모리에만 저장되며,<br/>
              서버나 외부로 전송되지 않습니다. 페이지를 새로고침하면 모든 데이터가 삭제됩니다.<br/>
              <span style={{ fontSize: '0.85rem', opacity: 0.9 }}>
                결과를 보관하려면 반드시 엑셀 다운로드 기능을 사용하세요.
              </span>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<ClassAssignment />, document.getElementById('root'));
  </script>
</body>
</html>
